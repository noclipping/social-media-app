import Head from "next/head";
import styles from "../styles/Home.module.css";
import PostImage from "../components/PostImage";

import { useS3Upload } from "next-s3-upload";
import { useSession, signIn, signOut } from "next-auth/react";
import Post from "../components/Post";
import { useState } from "react";
import { server } from "../config/index";
import { useEffect } from "react";
export default function Home({ data }) {
  const { data: session } = useSession();
  const [newPost, setNewPost] = useState("");
  const [allPosts, setAllPosts] = useState();
  const [posts, setPosts] = useState();
  const [errMessage, setErrMessage] = useState("");
  const [theFile, setTheFile] = useState();
  const [img, setImg] = useState();
  const [displayState, setDisplayState] = useState("none");
  let { uploadToS3 } = useS3Upload();
  async function handleFileChange(file) {
    setImg(URL.createObjectURL(file));
    try {
      setImg(URL.createObjectURL(file));
    } catch {
      console.log("canceled img");
      return;
    }

    setDisplayState("inline-block");
    setTheFile(file);
    console.log("epicness");
  }
  function deletePost(postId, imgURL) {
    setPosts(posts.filter((post) => post._id != postId));
    console.log(imgURL);
    let deletion = "";
    if (imgURL) {
      deletion = imgURL.slice(48);
    }
    console.log(deletion, "deletion");
    fetch(`${server}/api/posts/delete`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        postId,
        deleteUrl: deletion,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        console.log(data);
      });
  }
  async function submitPost(e) {
    e.preventDefault();

    let url = "";

    if (theFile) {
      if (theFile.size > 2000000) {
        setErrMessage("file size too large!");
        return;
      }
      let result = await uploadToS3(theFile);
      url = result.url;
    }
    console.log(url, "daurl");
    fetch(`${server}/api/posts/create`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        uid: session?.user._id,
        username: session?.user.username,
        content: newPost,
        imgURL: url,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.error) {
          console.log(data.message);
          setErrMessage(data.message);
          return;
        }
        console.log(data);
        setNewPost("");
        setErrMessage("");
        setImg();
        setTheFile();
        setDisplayState("none");
        document.getElementById("postInput").value = "";
        setPosts((prevPosts) => [data, ...prevPosts]);
      });
  }
  useEffect(() => {
    setAllPosts(data.posts);
    setPosts(data.posts);
  }, []);

  function handleFilter(e) {
    // location.reload();
    if (e.target.value === "friends") {
      setPosts(
        posts.filter((post) => {
          if (session?.user?.friends.includes(post.uid)) {
            return post;
          }
        })
      );
    } else if (e.target.value === "all") {
      setPosts(allPosts);
    }
  }

  return (
    <div>
      <Head>
        <title>Social-Humans</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      {/* container including posts below */}
      <div className={styles.container}>
        <div>
          <div style={{ width: "80%", margin: "0 auto" }}>
            <form
              onChange={(e) => {
                console.log(e.target.value);
                handleFilter(e);
              }}
            >
              <label id="filter" style={{ display: "inline-block" }}>
                Filter Posts:
              </label>
              <select
                style={{
                  backgroundColor: "black",
                  color: "white",
                  display: "inline-block",
                }}
                name="filter"
                id="filter"
              >
                <option value="all">all</option>
                <option value="friends">friends</option>
              </select>
            </form>

            {errMessage.length > 1 ? (
              <p style={{ color: "red" }}>{errMessage}</p>
            ) : (
              ""
            )}
            <form>
              <br />
              <div style={{ display: "flex", alignItems: "center" }}>
                <img
                  src={
                    session?.user
                      ? session.user.image
                      : "https://i.stack.imgur.com/34AD2.jpg"
                  }
                  style={{
                    display: "inline-block",
                    width: "30px",
                    height: "30px",
                    borderRadius: "50%",
                    margin: "5px",
                  }}
                />
                <input
                  id="postInput"
                  className={styles.postInput}
                  placeholder={`What's on your mind ${session?.user?.username}?`}
                  onChange={(e) => {
                    setNewPost(e.target.value);
                  }}
                />
                {/* <AiOutlinePaperClip size="35px" cursor="pointer" /> */}
                <PostImage
                  handleFileChange={handleFileChange}
                  setTheFile={setTheFile}
                  style={{ display: "inline-block" }}
                />

                <img
                  style={{
                    width: "200px",
                    height: "200px",
                    display: `${displayState}`,
                  }}
                  src={img}
                  alt=""
                />

                <button
                  style={{ width: "20%", display: "none" }}
                  onClick={submitPost}
                >
                  Submit
                </button>
              </div>
            </form>
          </div>
          {data
            ? posts?.map((post) => {
                return (
                  <Post post={post} key={post._id} deletePost={deletePost} />
                );
              })
            : ""}
        </div>
      </div>
    </div>
  );
}

export async function getServerSideProps() {
  const res = await fetch(`${server}/api/posts`);
  const data = await res.json();
  return { props: { data } };
}
